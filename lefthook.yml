# Lefthook configuration for code formatting and linting
# https://github.com/evilmartians/lefthook

pre-commit:
  parallel: true
  commands:
    # Format Go files
    go-fmt:
      glob: "*.go"
      run: gofmt -w {staged_files} && git add {staged_files}

    go-imports:
      glob: "*.go"
      run: go tool goimports -w {staged_files} && git add {staged_files}

    # Format C++ files
    clang-format:
      glob: "*.{cc,h,cpp,hpp}"
      run: |
        if command -v clang-format > /dev/null 2>&1; then
          clang-format -i {staged_files} && git add {staged_files}
        else
          echo "Warning: clang-format not found. Install it for your platform."
        fi

    # Format Bazel/Starlark files
    buildifier:
      glob: "{BUILD,*.bzl,WORKSPACE,*.bazel}"
      run: go tool buildifier -mode=fix {staged_files} && git add {staged_files}

    # Format and lint JavaScript/TypeScript/JSON files with Biome
    biome-format:
      glob: "*.{js,ts,jsx,tsx,json,jsonc}"
      run: |
        if command -v npx > /dev/null 2>&1; then
          npx --yes @biomejs/biome format --write {staged_files} && git add {staged_files}
        else
          echo "Warning: npx not found. Skipping Biome formatting."
        fi

    biome-lint:
      glob: "*.{js,ts,jsx,tsx,json,jsonc}"
      run: |
        if command -v npx > /dev/null 2>&1; then
          npx --yes @biomejs/biome lint --write {staged_files} && git add {staged_files}
        else
          echo "Warning: npx not found. Skipping Biome linting."
        fi

    # Format CSS/HTML/Markdown files with prettier (Biome doesn't support these)
    prettier:
      glob: "*.{css,html,md}"
      run: |
        if command -v npx > /dev/null 2>&1; then
          npx --yes prettier --write {staged_files} && git add {staged_files}
        else
          echo "Warning: npx not found. Skipping prettier formatting."
        fi

    # Strip trailing whitespace and ensure single trailing newline
    fix-whitespace:
      glob: "*.{go,cc,h,cpp,hpp,js,ts,json,css,html,md,bzl,bazel,yml,yaml,sh}"
      run: |
        for file in {staged_files}; do
          # Strip trailing whitespace from each line
          sed -i '' 's/[[:space:]]*$//' "$file"

          # Ensure file ends with exactly one newline
          # Remove all trailing blank lines
          sed -i '' -e :a -e '/^\n*$/{$d;N;ba' -e '}' "$file"
          # Add newline only if file doesn't end with one
          if [ -n "$(tail -c 1 "$file")" ]; then
            printf '\n' >> "$file"
          fi

          git add "$file"
        done

    # Run golangci-lint (mandatory)
    go-lint:
      glob: "*.go"
      run: |
        if ! command -v golangci-lint > /dev/null 2>&1; then
          echo "Error: golangci-lint not installed. Linting is mandatory."
          echo "Install with: go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest"
          exit 1
        fi
        golangci-lint run --fix
        if [ $? -ne 0 ]; then
          echo "Error: golangci-lint found issues that could not be auto-fixed."
          exit 1
        fi

# Optional: Run formatters on all files (not just staged)
format:
  parallel: true
  commands:
    go:
      run: gofmt -w .

    go-imports:
      run: find . -name "*.go" -not -path "*/bazel-*" -exec go tool goimports -w {} +

    cpp:
      run: |
        if command -v clang-format > /dev/null 2>&1; then
          find . \( -name "*.cc" -o -name "*.h" -o -name "*.cpp" -o -name "*.hpp" \) -not -path "*/bazel-*" -exec clang-format -i {} +
        fi

    bazel:
      run: find . \( -name "BUILD" -o -name "*.bzl" -o -name "WORKSPACE" -o -name "*.bazel" \) -not -path "*/bazel-*" -exec go tool buildifier -mode=fix {} +

    biome:
      run: |
        if command -v npx > /dev/null 2>&1; then
          find pkg/web/static -type f \( -name "*.js" -o -name "*.ts" -o -name "*.jsx" -o -name "*.tsx" -o -name "*.json" -o -name "*.jsonc" \) -exec npx --yes @biomejs/biome format --write {} +
        fi

    prettier:
      run: |
        if command -v npx > /dev/null 2>&1; then
          npx --yes prettier --write "pkg/web/static/**/*.{css,html}" "**/*.md"
        fi

    whitespace:
      run: |
        find . -type f \( -name "*.go" -o -name "*.cc" -o -name "*.h" -o -name "*.js" -o -name "*.ts" -o -name "*.css" -o -name "*.html" -o -name "*.md" \) -not -path "*/bazel-*" -not -path "*/.git/*" -not -path "*/node_modules/*" | while read file; do
          sed -i '' 's/[[:space:]]*$//' "$file"
          sed -i '' -e :a -e '/^\n*$/{$d;N;ba' -e '}' "$file"
          if [ -n "$(tail -c 1 "$file")" ]; then
            printf '\n' >> "$file"
          fi
        done
